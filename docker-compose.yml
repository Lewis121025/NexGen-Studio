services:
  lewis-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lewis-api
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: postgresql+asyncpg://lewis:lewis_pass@postgres:5432/lewis_db
      REDIS_URL: redis://redis:6379/0
      VECTOR_DB_URL: http://weaviate:8080
      
      # 核心API密钥
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      DOUBAO_API_KEY: ${DOUBAO_API_KEY}
      
      # 通用模式工具
      E2B_API_KEY: ${E2B_API_KEY}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY}
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY}
      ZAPIER_NLA_API_KEY: ${ZAPIER_NLA_API_KEY}
      
      # 应用配置
      SECRET_KEY: ${SECRET_KEY:-changeme}
      API_KEY_SALT: ${API_KEY_SALT:-changeme}
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      TRUSTED_HOSTS: ${TRUSTED_HOSTS:-*,localhost,127.0.0.1}
      
      # 可选第三方服务
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-lewis-artifacts}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      weaviate:
        condition: service_started
    restart: unless-stopped
    networks:
      - lewis-network
    volumes:
      - ./artifacts:/app/artifacts
      - ./src:/app/src

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: lewis-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://lewis-api:8000
    depends_on:
      - lewis-api
    restart: unless-stopped
    networks:
      - lewis-network

  # PostgreSQL database
  postgres:
    image: postgres:15-alpine
    container_name: lewis-postgres
    environment:
      - POSTGRES_USER=lewis
      - POSTGRES_PASSWORD=lewis_pass
      - POSTGRES_DB=lewis_db
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - lewis-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lewis"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and rate limiting
  redis:
    image: redis:7-alpine
    container_name: lewis-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - lewis-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Weaviate vector database
  weaviate:
    image: semitechnologies/weaviate:latest
    container_name: lewis-weaviate
    ports:
      - "8080:8080"
    environment:
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=none
      - CLUSTER_HOSTNAME=node1
    volumes:
      - weaviate-data:/var/lib/weaviate
    restart: unless-stopped
    networks:
      - lewis-network

  # ARQ Worker for async tasks (video generation, etc.)
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lewis-worker
    command: arq lewis_ai_system.task_queue.WorkerSettings
    env_file:
      - .env
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: postgresql+asyncpg://lewis:lewis_pass@postgres:5432/lewis_db
      REDIS_URL: redis://redis:6379/0
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      RUNWAY_API_KEY: ${RUNWAY_API_KEY:-}
      E2B_API_KEY: ${E2B_API_KEY:-}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - lewis-network
    volumes:
      - ./artifacts:/app/artifacts

volumes:
  postgres-data:
  redis-data:
  weaviate-data:

networks:
  lewis-network:
    driver: bridge
